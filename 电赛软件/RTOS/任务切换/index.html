<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>任务切换 - 个人技术与学习笔记</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u4efb\u52a1\u5207\u6362";
        var mkdocs_page_input_path = "\u7535\u8d5b\u8f6f\u4ef6/RTOS/\u4efb\u52a1\u5207\u6362.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> 个人技术与学习笔记
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">首页</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">机器学习 (Machine Learning)</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" >Pytorch 学习</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/Pytorch_Learning/nn/">nn 神经网络</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/Pytorch_Learning/tensor/">Tensor</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/Pytorch_Learning/data/">data 数据处理</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/Pytorch_Learning/transfrom/">transform</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/Pytorch_Learning/tensorboard/">tensorboard 可视化</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/Pytorch_Learning/Test/">Test Notebook</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">电赛软件 (Embedded Software)</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../../%E7%94%B5%E8%B5%9B%E8%BD%AF%E4%BB%B6/">简介</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >ARM 架构</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../ARM%E6%9E%B6%E6%9E%84/ARM%E6%9E%B6%E6%9E%84/">ARM 架构概述</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ARM%E6%9E%B6%E6%9E%84/ARM%20Cortex-M%20CPU%20%E6%9E%B6%E6%9E%84/">ARM Cortex-M CPU 架构</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ARM%E6%9E%B6%E6%9E%84/%E9%80%9A%E7%94%A8%E5%AF%84%E5%AD%98%E5%99%A8/">通用寄存器</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../ARM%E6%9E%B6%E6%9E%84/%E7%89%B9%E6%AE%8A%E5%AF%84%E5%AD%98%E5%99%A8xPSR/">特殊寄存器xPSR</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >RTOS 实时操作系统</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../RTOS/">简介</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../%E4%BB%BB%E5%8A%A1%E5%A0%86%E6%A0%88/">任务堆栈</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">任务切换</a>
    <ul class="current">
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >FreeRTOS</a>
    <ul>
                <li class="toctree-l3"><a class="" href="../../../电赛软件/RTOS/FreeRTOS/FreeRTOS.md">FreeRTOS 简介</a>
                </li>
                <li class="toctree-l3"><a class="" href="../../../电赛软件/RTOS/FreeRTOS/任务创建和删除.md">任务创建和删除</a>
                </li>
                <li class="toctree-l3"><a class="" href="../../../电赛软件/RTOS/FreeRTOS/任务调度.md">任务调度</a>
                </li>
                <li class="toctree-l3"><a class="" href="../../../电赛软件/RTOS/FreeRTOS/任务通知.md">任务通知</a>
                </li>
                <li class="toctree-l3"><a class="" href="../../../电赛软件/RTOS/FreeRTOS/内存管理.md">内存管理</a>
                </li>
                <li class="toctree-l3"><a class="" href="../../../电赛软件/RTOS/FreeRTOS/同步、互斥与通信.md">同步、互斥与通信</a>
                </li>
                <li class="toctree-l3"><a class="" href="../../../电赛软件/RTOS/FreeRTOS/队列.md">队列</a>
                </li>
                <li class="toctree-l3"><a class="" href="../../../电赛软件/RTOS/FreeRTOS/队列集.md">队列集</a>
                </li>
                <li class="toctree-l3"><a class="" href="../../../电赛软件/RTOS/FreeRTOS/中断管理.md">中断管理</a>
                </li>
                <li class="toctree-l3"><a class="" href="../../../电赛软件/RTOS/FreeRTOS/移植.md">移植</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >STM32 HAL 库</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../STM32%20HAL%E5%BA%93/STM32%20HAL%E5%BA%93/">库介绍</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../STM32%20HAL%E5%BA%93/GPIO%E6%93%8D%E4%BD%9C/">GPIO 操作</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../STM32%20HAL%E5%BA%93/NVIC/">NVIC</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../STM32%20HAL%E5%BA%93/DMA/">DMA</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../STM32%20HAL%E5%BA%93/ADC/">ADC</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../STM32%20HAL%E5%BA%93/%E5%AE%9A%E6%97%B6%E5%99%A8/">定时器</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../STM32%20HAL%E5%BA%93/FLASH/">FLASH</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../STM32%20HAL%E5%BA%93/BKP%26RTC/">BKP & RTC</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../STM32%20HAL%E5%BA%93/WDG/">WDG</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../STM32%20HAL%E5%BA%93/%E7%A1%AC%E4%BB%B6%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/">硬件通信协议</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >通信协议</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/">简介</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/I2C/">I2C</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/SPI/">SPI</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/USART/">USART</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/CAN/">CAN</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >电控算法</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../%E7%94%B5%E6%8E%A7%E7%AE%97%E6%B3%95/%E7%94%B5%E6%8E%A7%E7%AE%97%E6%B3%95/">简介</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../%E7%94%B5%E6%8E%A7%E7%AE%97%E6%B3%95/PID/">PID</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../%E7%94%B5%E6%8E%A7%E7%AE%97%E6%B3%95/LQR/">LQR</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../%E7%94%B5%E6%8E%A7%E7%AE%97%E6%B3%95/SMC/">SMC</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >视觉应用</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../%E8%A7%86%E8%A7%89/%E8%A7%86%E8%A7%89/">视觉</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../%E8%A7%86%E8%A7%89/Micropython%20%26%20K230/">Micropython & K230</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">个人技术与学习笔记</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">电赛软件 (Embedded Software)</li>
          <li class="breadcrumb-item">RTOS 实时操作系统</li>
      <li class="breadcrumb-item active">任务切换</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="_1">任务栈的基本结构</h1>
<p>RTOS中每个任务都有独立的栈空间，栈底位于高地址，栈向低地址增长：</p>
<pre><code>典型任务栈内存布局：
+------------------+ ← 栈起始地址 (高地址)
|   栈保护区域     |
|   (魔数填充)     |
+------------------+
|   未使用栈空间   |
|                 |
+------------------+
|   函数调用帧     |
|   局部变量       |
+------------------+
|   任务上下文     |
|   (保存的寄存器) |
+------------------+ ← 当前栈指针SP位置 (低地址)
</code></pre>
<h1 id="_2">任务上下文</h1>
<p>任务上下文包含处理器完整状态，分为硬件自动保存和软件手动保存两部分：</p>
<h2 id="_3">硬件自动保存的寄存器</h2>
<ul>
<li>R0-R3：参数寄存器</li>
<li>R12：临时寄存器  </li>
<li>LR（R14）：链接寄存器</li>
<li>PC（R15）：程序计数器</li>
<li>xPSR：程序状态寄存器</li>
</ul>
<h2 id="_4">软件手动保存的寄存器</h2>
<ul>
<li>R4-R11：通用寄存器</li>
<li>可选：浮点寄存器、特殊功能寄存器</li>
</ul>
<h1 id="_5">任务切换触发机制</h1>
<p>任务切换由多种条件触发，完整的切换流程如下：</p>
<pre><code>任务切换完整流程：
+------------------+
|  任务A正常运行   |
|  SP_A指向任务A栈 |
+------------------+
         |
         ↓ (中断/系统调用触发)
+------------------+
|  硬件自动保存    |
|  R0-R3, R12,     |
|  LR, PC, xPSR    |
+------------------+
         |
         ↓ (进入PendSV异常)
+------------------+
|  软件手动保存    |
|  R4-R11到任务A栈 |
+------------------+
         |
         ↓
+------------------+
|  更新TCB_A中的   |
|  栈指针SP_A      |
+------------------+
         |
         ↓
+------------------+
|  调度器选择      |
|  下一个任务B     |
+------------------+
         |
         ↓
+------------------+
|  从TCB_B加载     |
|  栈指针SP_B      |
+------------------+
         |
         ↓
+------------------+
|  软件手动恢复    |
|  R4-R11从任务B栈 |
+------------------+
         |
         ↓
+------------------+
|  更新PSP为SP_B   |
+------------------+
         |
         ↓ (异常返回)
+------------------+
|  硬件自动恢复    |
|  R0-R3, R12,     |
|  LR, PC, xPSR    |
+------------------+
         |
         ↓
+------------------+
|  任务B继续运行   |
|  SP_B指向任务B栈 |
+------------------+
</code></pre>
<h1 id="_6">完整的栈帧结构</h1>
<p>任务切换时的完整栈帧结构：</p>
<pre><code>完整任务栈帧布局：
+------------------+ ← 栈底 (高地址)
|   栈保护区域     |
|   (0xDEADBEEF等) |
+------------------+
|   历史栈数据     |
|   函数调用帧     |
|   局部变量等      |
+------------------+
|  手动保存寄存器   | ← 软件保存区域开始
|      R11        |
+------------------+
|      R10        |
+------------------+
|      R9         |
+------------------+
|      R8         |
+------------------+
|      R7         |
+------------------+
|      R6         |
+------------------+
|      R5         |
+------------------+
|      R4         |
+------------------+ ← 手动保存结束
|  自动保存寄存器   | ← 硬件自动保存区域开始
|      R0         |
+------------------+
|      R1         |
+------------------+
|      R2         |
+------------------+
|      R3         |
+------------------+
|      R12        |
+------------------+
|      LR         |
+------------------+
|      PC         |
+------------------+
|      xPSR       |
+------------------+ ← 当前PSP指向的位置 (栈顶)
</code></pre>
<h1 id="_7">上下文保存过程详解</h1>
<h2 id="_8">硬件自动保存阶段</h2>
<p>当中断或异常发生时，硬件自动保存部分寄存器：</p>
<pre><code>硬件自动保存过程：
原始栈状态：
+------------------+ ← PSP
|   任务正常数据   |
|                 |
+------------------+

硬件自动保存后：
+------------------+ ← 原始PSP
|   任务正常数据   |
|                 |
+------------------+
|      xPSR       | ← 硬件自动保存开始
+------------------+
|       PC        |
+------------------+
|       LR        |
+------------------+
|      R12        |
+------------------+
|       R3        |
+------------------+
|       R2        |
+------------------+
|       R1        |
+------------------+
|       R0        |
+------------------+ ← 新的PSP (硬件保存后栈顶)
</code></pre>
<h2 id="_9">软件手动保存阶段</h2>
<p>在PendSV异常处理程序中手动保存剩余寄存器：</p>
<pre><code class="language-assembly">PendSV_Handler:
    ; 获取当前任务栈指针
    MRS R0, PSP                   ; R0 = 当前PSP值

    ; 检查是否是第一次任务切换
    CBZ R0, skip_save             ; 如果PSP为0，跳过保存

    ; 手动保存R4-R11到任务栈
    STMDB R0!, {R4-R11}           ; 递减存储，向低地址保存

    ; 更新TCB中的栈指针
    LDR R1, =CurrentTCB
    LDR R2, [R1]
    STR R0, [R2]                  ; 保存新PSP到TCB

skip_save:
    ; 继续执行任务切换...
</code></pre>
<p>保存后的栈状态变化：</p>
<pre><code>软件手动保存后的栈：
+------------------+ ← 原始PSP
|   任务正常数据   |
|                 |
+------------------+
|      xPSR       |
+------------------+
|       PC        |
+------------------+
|       LR        |
+------------------+
|      R12        |
+------------------+
|       R3        |
+------------------+
|       R2        |
+------------------+
|       R1        |
+------------------+
|       R0        |
+------------------+ ← 硬件保存后位置
|       R4        | ← 软件手动保存开始
+------------------+
|       R5        |
+------------------+
|       R6        |
+------------------+
|       R7        |
+------------------+
|       R8        |
+------------------+
|       R9        |
+------------------+
|      R10        |
+------------------+
|      R11        |
+------------------+ ← 新的PSP (软件保存后栈顶)
</code></pre>
<h1 id="_10">上下文恢复过程详解</h1>
<p>上下文恢复是保存过程的精确逆序：</p>
<h2 id="_11">软件手动恢复阶段</h2>
<pre><code class="language-assembly">PendSV_Handler_Restore:
    ; 切换到新任务
    LDR R1, =NextTCB
    LDR R2, [R1]
    LDR R0, [R2]                 ; 获取新任务的栈指针

    ; 手动恢复R4-R11
    LDMIA R0!, {R4-R11}          ; 递增加载，从栈中恢复寄存器

    ; 更新PSP指向硬件自动保存区域
    MSR PSP, R0

    ; 准备异常返回
    ORR LR, LR, #0x04           ; 确保返回时使用PSP
    BX LR                        ; 异常返回，触发硬件自动恢复
</code></pre>
<p>恢复过程中的栈状态变化：</p>
<pre><code>上下文恢复过程：
恢复前的栈状态：
+------------------+ ← 栈底
|   任务B历史数据   |
|                 |
+------------------+
|      xPSR       |
+------------------+
|       PC        |
+------------------+
|       LR        |
+------------------+
|      R12        |
+------------------+
|       R3        |
+------------------+
|       R2        |
+------------------+
|       R1        |
+------------------+
|       R0        |
+------------------+
|       R4        |
+------------------+
|       R5        |
+------------------+
|       R6        |
+------------------+
|       R7        |
+------------------+
|       R8        |
+------------------+
|       R9        |
+------------------+
|      R10        |
+------------------+
|      R11        |
+------------------+ ← 恢复前PSP指向的位置

恢复R4-R11后：
+------------------+ ← 栈底
|   任务B历史数据   |
|                 |
+------------------+
|      xPSR       |
+------------------+
|       PC        |
+------------------+
|       LR        |
+------------------+
|      R12        |
+------------------+
|       R3        |
+------------------+
|       R2        |
+------------------+
|       R1        |
+------------------+
|       R0        |
+------------------+ ← 恢复后PSP指向的位置
|   已弹出的R4-R11  | (数据仍在栈中，但寄存器已恢复)
+------------------+
</code></pre>
<h2 id="_12">硬件自动恢复阶段</h2>
<p>异常返回时，硬件自动恢复剩余寄存器：</p>
<pre><code>硬件自动恢复过程：
异常返回时硬件自动：
1. 从PSP指向的位置开始弹出寄存器
2. 依次恢复R0, R1, R2, R3, R12, LR, PC, xPSR
3. PSP自动更新到原始位置

恢复后的栈状态：
+------------------+ ← 栈底
|   任务B历史数据   |
|                 |
+------------------+ ← 恢复后PSP指向的位置
|   已弹出的所有     |
|   上下文数据      |
+------------------+
</code></pre>
<h1 id="_13">完整的汇编实现</h1>
<p>基于ARM Cortex-M架构的完整任务切换代码：</p>
<pre><code class="language-assembly">; 常量定义
CurrentTCB    DCD 0    ; 当前任务TCB指针
NextTCB       DCD 0    ; 下一个任务TCB指针

; PendSV异常处理程序 - 任务切换核心
PendSV_Handler:
    ; 禁用中断，确保原子操作
    CPSID I

    ; 检查是否需要保存当前任务上下文
    MRS R0, PSP                   ; 获取当前任务栈指针
    CBZ R0, PendSV_Restore        ; 如果PSP为0，是第一次切换，跳过保存

    ; 保存当前任务上下文
    ; 硬件已自动保存: xPSR, PC, LR, R12, R0-R3
    ; 需要手动保存: R4-R11
    STMDB R0!, {R4-R11}           ; 保存R4-R11到任务栈

    ; 更新当前任务的栈指针到TCB
    LDR R1, =CurrentTCB
    LDR R2, [R1]
    STR R0, [R2]                  ; 保存更新后的PSP到TCB

PendSV_Restore:
    ; 恢复下一个任务的上下文
    LDR R1, =NextTCB
    LDR R2, [R1]
    LDR R0, [R2]                  ; 获取新任务的栈指针

    ; 手动恢复R4-R11
    LDMIA R0!, {R4-R11}           ; 从栈中恢复R4-R11

    ; 更新PSP为新任务的栈指针
    MSR PSP, R0

    ; 更新CurrentTCB为NextTCB
    LDR R1, =CurrentTCB
    LDR R2, =NextTCB
    LDR R3, [R2]
    STR R3, [R1]

    ; 启用中断
    CPSIE I

    ; 异常返回，硬件将自动恢复: xPSR, PC, LR, R12, R0-R3
    ORR LR, LR, #0x04             ; 确保返回时使用PSP
    BX LR                         ; 返回到新任务
</code></pre>
<h1 id="_14">栈指针管理机制</h1>
<p>任务控制块(TCB)与任务栈的关系：</p>
<pre><code>任务管理数据结构：
TCB结构：
+------------------+
|  任务ID         |
|  任务状态       |
|  优先级         |
|  栈起始地址     | ---→ +------------------+ ← 栈底
|  栈大小         |      |   任务栈空间     |
|  当前栈指针SP   | ---→ |                 |
|  等待事件       |      |                 |
|  时间片计数器   |      |                 |
+------------------+      +------------------+ ← SP指向的位置
</code></pre>
<p>任务切换时的栈指针更新：</p>
<pre><code>栈指针切换过程：
任务A → 任务B切换：

任务A运行中:
TCB_A.SP → +------------------+ ← PSP
           |   任务A栈数据     |
           |                 |
           +------------------+

保存上下文后:
TCB_A.SP → +------------------+ ← 新PSP (保存后)
           |   任务A上下文     |
           |                 |
           +------------------+

切换到任务B:
TCB_B.SP → +------------------+ ← 新PSP (恢复前)
           |   任务B上下文     |
           |                 |
           +------------------+

恢复上下文后:
TCB_B.SP → +------------------+ ← PSP (恢复后)
           |   任务B栈数据     |
           |                 |
           +------------------+
</code></pre>
<h1 id="_15">不同架构的差异处理</h1>
<p>各架构上下文保存的差异：</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>ARM Cortex-M</th>
<th>x86</th>
<th>RISC-V</th>
</tr>
</thead>
<tbody>
<tr>
<td>自动保存寄存器</td>
<td>xPSR, PC, LR, R12, R0-R3</td>
<td>SS, SP, FLAGS, CS, IP</td>
<td>PC, 状态寄存器</td>
</tr>
<tr>
<td>手动保存寄存器</td>
<td>R4-R11</td>
<td>通用寄存器</td>
<td>调用者保存寄存器</td>
</tr>
<tr>
<td>栈增长方向</td>
<td>满递减</td>
<td>满递减</td>
<td>可配置</td>
</tr>
<tr>
<td>异常返回指令</td>
<td>BX LR</td>
<td>IRET</td>
<td>MRET</td>
</tr>
</tbody>
</table>
<h1 id="_16">栈溢出检测与优化</h1>
<p>栈使用监控和优化策略：</p>
<pre><code>栈使用分析：
+------------------+ ← 栈底
|   栈保护区域     |
|   (魔数检测)     |
+------------------+ ← 栈边界
|   未使用空间     |
|                 |
+------------------+ ← 最大历史使用水位
|   已使用空间     |
|                 |
+------------------+ ← 当前SP位置
|   安全边际       |
+------------------+ ← 栈顶

优化策略：
• 根据最大使用水位调整栈大小
• 设置栈保护区域检测溢出
• 避免深度递归和大型局部变量
• 使用静态分析工具确定合适栈大小
</code></pre>
<p>这样的设计确保了任务切换时上下文的完整保存和精确恢复，是RTOS可靠运行的基础。</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../%E4%BB%BB%E5%8A%A1%E5%A0%86%E6%A0%88/" class="btn btn-neutral float-left" title="任务堆栈"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../STM32%20HAL%E5%BA%93/STM32%20HAL%E5%BA%93/" class="btn btn-neutral float-right" title="库介绍">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Copyright &copy; 2025 马梓腾</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../%E4%BB%BB%E5%8A%A1%E5%A0%86%E6%A0%88/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../STM32%20HAL%E5%BA%93/STM32%20HAL%E5%BA%93/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
